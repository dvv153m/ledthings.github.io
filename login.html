<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- <meta name="viewport" content="width=device-width, user-scalable=yes" /> -->
	<link rel="stylesheet" href="bootstrap.min.css">
	<script type="text/javascript" src="consts.js"></script>
	<script type="text/javascript" src="mqttws31.js"></script>
	<script type="text/javascript">

		var mqtt;
		var mqttReconnectTimeout = 2000;
		var deviceType;
		var isReceivedIp = false;

		function getDeviceId() {

			var deviceIdUrl = "http://" + deviceAPHost + "/getId?";
			if (!IsDebug) {

				fetchData(deviceIdUrl)
					.then(data => {
						if (typeof data != "undefined") {
							
							mqttTopic = data.id;
						}					
					});
			}
		}

		function submit() {

			var ssid = document.getElementById("fssid").value;
			var password = document.getElementById("fpassword").value;

			//todo добавить проверку на пустоту ssid и password
			var loginUrl = "http://" + deviceAPHost + "/login?ssId=" + ssid + "&password=" + password;
			var restartDeviceUrl = "http://" + deviceAPHost + "/restart";

			if (!IsDebug) {

				fetchData(loginUrl)
					.then(data => {

						if (data.isSuccess) {

							deviceType = data.deviceType;
							fetchData(restartDeviceUrl).then(d => {

								let uu = 5 + 1;
								//mqttConnect();
							});
							mqttConnect();//todo попробовать сюда поместить
						}
						/*var device = {
							'localIp': data.localIp,
							'deviceType': data.deviceType,
							'deviceName': getDeviceName(data.deviceType)
						}

						saveDevice(device);

						//или вызвать метод рестарта (посмотреть что будет быстрее работать)
						//дописать then(d=> переход на страницу cloud взависимости от типа устройства)											
						/*fetchData(disconnectAPUrl).then(d => {

							var page = getPageByDeviceType(device.deviceType);
							window.location.href = page;
						});*/
						//проверить зайдет ли в then
						//stop busy indicator
					});
				//start busy indicator
			}
			else {

				var testDevice = {
					'localIp': "192.168.100.100",
					'deviceType': 3,
					'deviceName': getDeviceName(3)
				}
				saveDevice(testDevice);

				disconnectAPUrl = "http://" + testDevice.localIp + "/disconnectAP";

				var page = getPageByDeviceType(testDevice.deviceType);
				window.location.href = page;
			}
		}

		function mqttConnect() {

			var mqttClientId = "web_" + parseInt(Math.random() * 100, 10);

			mqtt = new Paho.MQTT.Client(
				mqttHost,
				mqttPort,
				mqttPath,
				mqttClientId
			);

			mqtt.onConnectionLost = onConnectionLost;
			mqtt.onMessageArrived = onMessageArrived;

			var options = {
				timeout: 3,
				useSSL: mqttUseTLS,
				userName: mqttUserName,
				password: mqttPassword,
				cleanSession: mqttCleanSession,
				onSuccess: onConnect,
				onFailure: function (message) {

					console.log("Connection failed: " + message.errorMessage + "Retsrying");
					setTimeout(mqttConnect, mqttReconnectTimeout);
				}
			};

			mqtt.connect(options);
		}

		function onConnect() {

			console.log('Connected to ' + mqttHost + ':' + mqttPort + mqttPath);
			// Connection succeeded; subscribe to our topic
			mqtt.subscribe(mqttTopic, { qos: 0 });
		}

		function onConnectionLost(response) {
			setTimeout(mqttConnect, mqttReconnectTimeout);
			console.log("connection lost: " + responseObject.errorMessage + ". Reconnecting");
		};

		function onMessageArrived(message) {
			var topic = message.destinationName;
			var payload = message.payloadString;
			//проверить что в payload находится ip
			if (isIpAddress(payload)) {				

				if (!isReceivedIp) {

					isReceivedIp = true;
					deviceAPHost = payload;
					var restartDeviceUrl = "http://" + deviceAPHost + "/stopSendMqtt";
					fetchData(restartDeviceUrl).then(d => {

						let uu = 5 + 1;
						//mqttConnect();
					});					

					var device = {
						'localIp': payload,
						'deviceType': deviceType,
						'deviceName': getDeviceName(deviceType)
					}

					saveDevice(device);

					var page = getPageByDeviceType(device.deviceType);
					window.location.href = page;
				}
			}
		};

		function isIpAddress(ipAddress) {

			var len = ipAddress.length;
			if(len > 0){

				return true;
			}
			else{

				return false;
			}			
		}

		function saveDevice(device) {

			var jsonDevice = JSON.stringify(device);
			localStorage.setItem(CurrentDeviceKey, jsonDevice);

			var restoredSession = JSON.parse(localStorage.getItem(DevicesKey));
			if (restoredSession != null &&
				restoredSession.devices != null &&
				restoredSession.devices.length > 0) {

				//todo сделать проверку на существование такого устройсва в коллекции
				restoredSession.devices.push(device);
				localStorage.setItem(DevicesKey, JSON.stringify(restoredSession));
			}
			else {

				var devicesInfo = {
					'devices': []
				};

				devicesInfo.devices.push(device);
				localStorage.setItem(DevicesKey, JSON.stringify(devicesInfo));
			}
		}

		function getDeviceName(deviceType) {

			switch (deviceType) {
				case DeviceType.None:
					return "Unknown";
				case DeviceType.Table60:
					return "Table";
				case DeviceType.Table91:
					return "Table";
				case DeviceType.Cloud:
					return "Cloud";
				case DeviceType.FirTree:
					return "FirTree";
				default:
					return "Unknown";
			}
		}

	</script>
</head>

<body onload="getDeviceId()">

	<br />
	<label>Connect to esp access point and fill fields</label>
	<br />
	<br />
	<label for="uname">SSid</label>
	<!--Выводить пользователю список wifi сетей-->
	<input type="text" placeholder="Enter ssid" name="uname" id="fssid" value="ASUSWiFi" required>
	<br />
	<label for="psw">Password</label>
	<input type="password" placeholder="Enter password" name="psw" id="fpassword" value="Akvalang741" required>
	<br />
	<button class="btn btn-light" onclick="submit()">Submit</button>
	<button class="btn btn-light" onclick="submit2()">Submit2</button>
	</div>
</body>

</html>