<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- <meta name="viewport" content="width=device-width, user-scalable=yes" /> -->
	<link rel="stylesheet" href="bootstrap.min.css">
	<style>
		.lds-ripple {
			display: none;
			position: relative;
			width: 64px;
			height: 64px;

		}

		.lds-ripple div {
			position: absolute;
			border: 4px solid #ccc;
			opacity: 1;
			border-radius: 50%;
			animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
		}

		.lds-ripple div:nth-child(2) {
			animation-delay: -0.5s;
		}

		@keyframes lds-ripple {
			0% {
				top: 28px;
				left: 28px;
				width: 0;
				height: 0;
				opacity: 1;
			}

			100% {
				top: -1px;
				left: -1px;
				width: 58px;
				height: 58px;
				opacity: 0;
			}
		}
	</style>
	<script type="text/javascript" src="consts.js"></script>
	<script type="text/javascript" src="mqttws31.js"></script>
	<script type="text/javascript">

		var mqtt;
		var mqttReconnectTimeout = 2000;
		var deviceType;
		var isReceivedIp = false;

		function submit2() {

			window.location.href = "cloud.html";
		}

		function submit() {

			var ssid = document.getElementById("fssid").value;
			var password = document.getElementById("fpassword").value;

			document.getElementById("busyIndicator").style.display = "block";
			document.getElementById("fssid").disabled = true;
			document.getElementById("fpassword").disabled = true;
			document.getElementById("save").disabled = true;
			document.getElementById("warningInfo").style.display = "none";
			//document.getElementById("save2").disabled = true;			

			//todo добавить проверку на пустоту ssid и password
			var deviceIdUrl = "http://" + deviceAPHost + "/getId?";
			var loginUrl = "http://" + deviceAPHost + "/login?ssId=" + ssid + "&password=" + password;
			var restartDeviceUrl = "http://" + deviceAPHost + "/restart";

			if (!IsDebug) {

				fetchData(deviceIdUrl).then(data => {

					if (typeof data != "undefined") {

						mqttTopic = data.id;
						fetchData(loginUrl)
							.then(data => {

								if (data.isSuccess) {

									deviceType = data.deviceType;
									fetchData(restartDeviceUrl);
									mqttConnect();//todo попробовать сюда поместить
								}
								else {

									//вывести сообщение с ошибкой
									document.getElementById("warningInfo").style.display = "block";
									document.getElementById("warningInfo").innerHTML = data.error;
									document.getElementById("busyIndicator").style.display = "none";

									document.getElementById("fssid").disabled = false;
									document.getElementById("fpassword").disabled = false;
									document.getElementById("save").disabled = false;
								}
							});
					} else {

						document.getElementById("busyIndicator").style.display = "none";
						document.getElementById("warningInfo").style.display = "block";
						document.getElementById("warningInfo").innerHTML = "No data from device, please connect to Ledthings access point";
					}
				});
			}
			else {

				/*var testDevice = {
					'localIp': "192.168.100.100",
					'deviceType': 3,
					'deviceName': getDeviceName(3)
				}
				saveDevice(testDevice);

				disconnectAPUrl = "http://" + testDevice.localIp + "/disconnectAP";

				var page = getPageByDeviceType(testDevice.deviceType);
				window.location.href = page;*/
			}
		}

		function mqttConnect() {

			var mqttClientId = "web_" + parseInt(Math.random() * 100, 10);

			mqtt = new Paho.MQTT.Client(
				mqttHost,
				mqttPort,
				mqttPath,
				mqttClientId
			);

			mqtt.onConnectionLost = onConnectionLost;
			mqtt.onMessageArrived = onMessageArrived;

			var options = {
				timeout: 3,
				useSSL: mqttUseTLS,
				userName: mqttUserName,
				password: mqttPassword,
				cleanSession: mqttCleanSession,
				onSuccess: onConnect,
				onFailure: function (message) {

					console.log("Connection failed: " + message.errorMessage + "Retsrying");
					setTimeout(mqttConnect, mqttReconnectTimeout);
				}
			};

			mqtt.connect(options);
		}

		function onConnect() {

			console.log('Connected to ' + mqttHost + ':' + mqttPort + mqttPath);
			// Connection succeeded; subscribe to our topic
			mqtt.subscribe(mqttTopic, { qos: 0 });
		}

		function onConnectionLost(response) {
			setTimeout(mqttConnect, mqttReconnectTimeout);
			console.log("connection lost: " + responseObject.errorMessage + ". Reconnecting");
		};

		function onMessageArrived(message) {
			var topic = message.destinationName;
			var payload = message.payloadString;
			//проверить что в payload находится ip
			if (isIpAddress(payload)) {

				if (!isReceivedIp) {

					isReceivedIp = true;
					deviceAPHost = payload;
					var stopSendMqttUrl = "http://" + deviceAPHost + "/stopSendMqtt";
					fetchData(stopSendMqttUrl);

					var device = {
						'localIp': payload,
						'deviceType': deviceType,
						'deviceName': getDeviceName(deviceType)
					}

					saveDevice(device);

					var page = getPageByDeviceType(device.deviceType);
					window.location.href = page;
				}
			}
		};

		function isIpAddress(ipAddress) {

			var len = ipAddress.length;
			if (len > 0) {

				return true;
			}
			else {

				return false;
			}
		}

		function saveDevice(device) {

			var jsonDevice = JSON.stringify(device);
			localStorage.setItem(CurrentDeviceKey, jsonDevice);

			var restoredSession = JSON.parse(localStorage.getItem(DevicesKey));
			if (restoredSession != null &&
				restoredSession.devices != null &&
				restoredSession.devices.length > 0) {

				//todo сделать проверку на существование такого устройсва в коллекции
				restoredSession.devices.push(device);
				localStorage.setItem(DevicesKey, JSON.stringify(restoredSession));
			}
			else {

				var devicesInfo = {
					'devices': []
				};

				devicesInfo.devices.push(device);
				localStorage.setItem(DevicesKey, JSON.stringify(devicesInfo));
			}
		}

		function getDeviceName(deviceType) {

			switch (deviceType) {
				case DeviceType.None:
					return "Unknown";
				case DeviceType.Table60:
					return "Table";
				case DeviceType.Table91:
					return "Table";
				case DeviceType.Cloud:
					return "Cloud";
				case DeviceType.FirTree:
					return "FirTree";
				default:
					return "Unknown";
			}
		}

	</script>
</head>

<body>
	<div class="alert alert-warning" role="alert" id="warningInfo" style="display: none"></div>
	<label class="row justify-content-center">Connect to esp access point and fill fields</label>

	<div align="center">
		<div class="lds-ripple row justify-content-center" id="busyIndicator">
			<div></div>
			<div></div>
		</div>
	</div>

	<center>
		<label for="uname">SSid</label>
		<!--Выводить пользователю список wifi сетей-->
		<input type="text" placeholder="Enter ssid" name="uname" id="fssid" value="ASUSWiFi" required>

		<br />
		<label for="psw">Password</label>
		<input type="password" placeholder="Enter password" name="psw" id="fpassword" value="Akvalang741" required>
		<br />
		<button class="btn btn-light" id="save" onclick="submit()">Submit</button>
		<!---<button class="btn btn-light" id="save2" onclick="submit2()">Submit2</button>-->
	</center>
</body>

</html>